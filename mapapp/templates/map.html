<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Bus Routes Demo</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    #topbar {
      padding: 8px 12px;
      background: #f5f5f5;
      border-bottom: 1px solid #ddd;
    }
    #map {
      width: 100%;
      height: calc(100% - 46px);
    }
    select {
      padding: 4px 8px;
      min-width: 220px;
    }
  </style>
</head>

<body>
  <div id="topbar">
    <label for="routeSelect">Route:</label>
    <select id="routeSelect">
      <option value="">-- Select a route --</option>
      {% for r in routes %}
        <option value="{{ r.MaTuyen }}">
          {{ r.MaTuyen }} - {{ r.TenTuyen }}
        </option>
      {% endfor %}
    </select>
  </div>

  <div id="map"></div>

  <!-- Google Maps JS with key from .env -->
  <script src="https://maps.googleapis.com/maps/api/js?key={{ GG_API_KEY }}"></script>

  <script>
    let map;
    let currentPolyline = null;

    function initMap() {
      const center = { lat: 10.776, lng: 106.700 }; // adjust default
      map = new google.maps.Map(document.getElementById("map"), {
        zoom: 12,
        center: center,
      });
    }

    async function loadAndDrawRoute(maTuyen) {
      if (!maTuyen) {
        if (currentPolyline) {
          currentPolyline.setMap(null);
          currentPolyline = null;
        }
        return;
      }

      const res = await fetch(`/route-path/?MaTuyen=${encodeURIComponent(maTuyen)}`);
      if (!res.ok) {
        console.error("Failed to load route", await res.text());
        return;
      }
      const data = await res.json();
      const path = data.path || [];
      if (!path.length) {
        console.warn("Route has empty path");
        return;
      }

      // Remove previous line
      if (currentPolyline) {
        currentPolyline.setMap(null);
      }

      currentPolyline = new google.maps.Polyline({
        path: path, // [{lat, lng}, ...]
        map: map,
        strokeWeight: 4,
      });

      // Fit map to route
      const bounds = new google.maps.LatLngBounds();
      path.forEach(pt => bounds.extend(pt));
      map.fitBounds(bounds);
    }

    window.onload = function () {
      initMap();

      const select = document.getElementById("routeSelect");
      select.addEventListener("change", function () {
        loadAndDrawRoute(this.value);
      });
    };
  </script>
</body>
</html>
